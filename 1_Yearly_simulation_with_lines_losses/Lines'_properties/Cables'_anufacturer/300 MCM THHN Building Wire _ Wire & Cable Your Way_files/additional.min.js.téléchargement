define(['jquery','underscore','mage/translate','text!MageWorx_OptionFeatures/template/option/gallery/dropdown.html','text!MageWorx_OptionFeatures/template/option/gallery/radio.html','text!MageWorx_OptionFeatures/template/option/gallery/checkbox.html','text!MageWorx_OptionFeatures/template/option/gallery/empty.html','mwImageReplacer','jquery/validate','jquery/ui','jquery/jquery.parsequery'],function($,_,$t,dropDownTmpl,radioTmpl,checkboxTmpl,emptyTmpl,replacer){'use strict';$.widget('mageworx.optionAdditionalImages',{options:{customOptionClassSelector:'.product-custom-option',imagesContainerClass:'option_images_gallery',currentOptionId:null,images:[],$element:null,templates:{'drop_down':dropDownTmpl,'radio':radioTmpl,'checkbox':checkboxTmpl,'multiple':dropDownTmpl},image_replacement_candidates:{}},firstRun:function firstRun(optionConfig,productConfig,base,self){var params=this.options;$(params.customOptionClassSelector).each(function(){var $element=$(this);params.$element=$element;if(self.out()){return;}
var imagesContainer='<div class="'+params.imagesContainerClass+'"/>';$element.parent().append(imagesContainer);if(self.getOGType()==self.getOGTypeBesideOption()){self.elementChange();}
if(self.getOptionType()=='drop_down'||self.getOptionType()=='multiple'){self._observeStyleOptions();}});},update:function update(option,optionConfig,productConfig,base){this.options.$element=$(option);if(this.out()){return;}
this.elementChange();},out:function(){var optionId=this.resolveOptionId();this.options.currentOptionId=optionId;var optionType=this.getOptionType();return!optionId||!optionType||_.isUndefined(this.options.render_images_for_option_types)||this.options.render_images_for_option_types.indexOf(optionType)==-1;},resolveOptionId:function(){var id=this.options.$element.attr('id');id=id.replace('select_','').replace('options_','');if(id.match(/_/)){return id.split('_')[0];}
return id;},_observeStyleOptions:function(){var self=this,params=this.options,target=params.$element.find('option');var observer=new MutationObserver(function(mutations){mutations.forEach(function(mutationRecord){params.$element=$(mutationRecord.target).closest('.product-custom-option');params.currentOptionId=self.resolveOptionId();self.elementChange();});});$.each(target,function(i,e){observer.observe(e,{attributes:true,attributeFilter:['style']});});},elementChange:function(){this.clearImagesContainer();var valueIds=this.options.$element.val();if(this.getOGType()!=this.getOGTypeDisabled()){if(!valueIds&&this.isEnabledOptionReplaceMode()){var sortOrder=this.getOptionValueSortOrder(this.getOptionId(),null);this._removeCandidateForReplacement(sortOrder);replacer.forceRefresh();}}
if(this.isEnabledOptionReplaceMode()){this._removeUnselectedCandidates(this.getOptionId(),valueIds);replacer.forceRefresh();}
this._renderImages(valueIds);if(this.isEnabledOptionReplaceMode()){replacer.replace();}},_renderImages:function(valueIds){var images=this._prepareOptionImages(valueIds),currentOptionGalleryTemplate=this._resolveTemplateByOptionType(this.getOptionType());if(Object.keys(images).length>0){if(this.getOGType()==this.getOGTypeBesideOption()||this._isValueSelected()){if(this.getOptionType()=='radio'&&this.getOGType()!=this.getOGTypeBesideOption()){this._clearRadioImagesContainer();}
var template=_.template(currentOptionGalleryTemplate)({"images":images});var $imagesContainer=this.getOptionGalleryContainer();$imagesContainer.append(template);}}else if(this.isEnabledOptionReplaceMode()){var sortOrder=this.getOptionValueSortOrder(this.getOptionId(),null);this._removeCandidateForReplacement(sortOrder);replacer.forceRefresh();}},getOptionValueSortOrder:function(optionId,valueId){var params=this.options,sortOrder=params.options[optionId]['sort_order']*1000;if(!valueId){return sortOrder;}
if(params.$element.is('input[type="checkbox"]')||params.$element.is('select[multiple="multiple"]')){sortOrder+=parseInt(params.options[optionId]['values'][valueId]['sort_order']);}
return sortOrder;},_prepareOptionImages:function(valueIds){var self=this;var images={};if(_.isArray(valueIds)){_.each(valueIds,function(valueId,index){_.extend(images,self._prepareImages(valueId));});}else{var valueId=valueIds;images=this._prepareImages(valueId);}
return images;},_prepareImages:function(valueId){var images={},optionId=this.getOptionId(),params=this.options;if(valueId&&!_.isUndefined(params.options[optionId])&&!_.isUndefined(params.options[optionId]['values'])&&!_.isUndefined(params.options[optionId]['values'][valueId])&&!_.isUndefined(params.options[optionId]['values'][valueId]['images'])){images=$.extend(true,{},params.options[optionId]['values'][valueId]['images']);}
if(typeof params.$element=='undefined'||!params.$element instanceof jQuery){return;}
if(params.options[optionId]['mageworx_option_image_mode']!=0){for(var imageKey in images){images[imageKey]['additional_class']='mageworx-optionfeatures-option-gallery_image_selected';var sortOrder=this.getOptionValueSortOrder(optionId,valueId);if(images[imageKey]['replace_main_gallery_image']=='1'){if(this.isElementSelected()){this._addCandidateForReplacement(images[imageKey],sortOrder);}else{this._removeCandidateForReplacement(sortOrder);}}}}
if((this.getOptionType()=='drop_down'||this.getOptionType()=='multiple')&&this.getOGType()==this.getOGTypeBesideOption()){var values=params.options[optionId]['values'];for(var valueKey in values){if(valueKey==valueId||_.isUndefined(values[valueKey]['images'])){continue;}
var imagesClone={};var $swatches=params.$element.parent().find('.mageworx-swatch-option');if($swatches.length>0){$.each($swatches,function(index,element){var imageOptionId=$(element).attr('data-option-id');var imageOptionTypeId=$(element).attr('data-option-type-id');if($(element).css('display')!='none'&&!_.isUndefined(params.options[imageOptionId])&&!_.isUndefined(params.options[imageOptionId]['values'])&&!_.isUndefined(params.options[imageOptionId]['values'][imageOptionTypeId])&&!_.isUndefined(params.options[imageOptionId]['values'][imageOptionTypeId]['images'])&&params.$element.closest('[data-option_id]').css('display')!='none'){imagesClone=$.extend(true,imagesClone,params.options[imageOptionId]['values'][imageOptionTypeId]['images']);}});}else{$(params.$element).find('option').each(function(){var imageOptionId=params.currentOptionId;var imageOptionTypeId=$(this).val();if(imageOptionTypeId&&params.$element.closest('[data-option_id]').css('display')!='none'&&!_.isUndefined(params.options[imageOptionId])&&!_.isUndefined(params.options[imageOptionId]['values'])&&!_.isUndefined(params.options[imageOptionId]['values'][imageOptionTypeId])&&!_.isUndefined(params.options[imageOptionId]['values'][imageOptionTypeId]['images'])&&$(this).css('display')!='none'){imagesClone=$.extend(true,imagesClone,params.options[imageOptionId]['values'][imageOptionTypeId]['images']);}});}
_.extend(images,imagesClone);}}
return images;},_addCandidateForReplacement:function(image,sortOrder){replacer.addCandidate(image,sortOrder);},_removeCandidateForReplacement:function(sortOrder){replacer.removeCandidate(sortOrder);},_removeUnselectedCandidates:function(optionId,selectedValues){var self=this;var isCheckbox=false;var isUncheckedCheckbox=false;if(this.options.$element.is('input[type="checkbox"]')){isCheckbox=true;}
if(!this.options.$element.is(':checked')){isUncheckedCheckbox=true;}
if(isCheckbox&&isUncheckedCheckbox){var sortOrder=self.getOptionValueSortOrder(optionId,this.options.$element.val());replacer.removeCandidate(sortOrder);}else{for(var valueId in this.options.options[optionId]['values']){if(!isCheckbox&&!_.contains(selectedValues,valueId)&&selectedValues!=valueId){var sortOrder=self.getOptionValueSortOrder(optionId,valueId);replacer.removeCandidate(sortOrder);}}}},clearImagesContainer:function(){var params=this.options;var $imagesContainer=this.getOptionGalleryContainer();if(!_.isUndefined($imagesContainer)&&$imagesContainer instanceof jQuery){$imagesContainer.html('');}},_clearRadioImagesContainer:function(){var params=this.options,$imagesContainer=this.getOptionGalleryContainer(),$radioListContainer=$imagesContainer.parent().parent();$radioListContainer.find('input:radio').each(function(){$(this).parent().find('.option_images_gallery').html('');})},_isValueSelected:function(){var params=this.options;return this.getOGType()==this.getOGTypeOnceSelected()&&(params.$element.is(':checked')||((this.getOptionType()=='drop_down'||this.getOptionType()=='multiple')&&params.$element.val()))},_resolveTemplateByOptionType:function(optionType){return this.options.templates[optionType];},getOptionType:function(){if(_.isUndefined(this.options.options[this.getOptionId()])){return'';}
return this.options.options[this.getOptionId()]['type'];},getOptionId:function(){return this.options.currentOptionId;},getOGTypeDisabled:function(){return this.options.option_gallery_type.disabled;},getOGTypeBesideOption:function(){return this.options.option_gallery_type.beside_option;},getOGTypeOnceSelected:function(){return this.options.option_gallery_type.once_selected;},getOGType:function(){return this.options.options[this.getOptionId()]['mageworx_option_gallery'];},isEnabledOptionReplaceMode:function(){return this.options.options[this.getOptionId()]['mageworx_option_image_mode']==='1';},getOptionGalleryContainer:function(){return this.options.$element.parent().find('.'+this.options.imagesContainerClass);},isElementSelected:function(){var $element=this.options.$element;if($element.is('input:not([type="button"]):not([type="checkbox"]):not([type="radio"]):not([type="file"]), textarea, select')){return Boolean($element.val());}else if($element.is('input[type="radio"]')||$element.is('input[type="checkbox"]')){return $element.is(':checked');}
return false;}});return $.mageworx.optionAdditionalImages;});